services:
  postgres:
    image: postgres:18-alpine
    container_name: 3wc-db-dev
    environment:
      POSTGRES_DB: threewc
      POSTGRES_USER: threewc
      POSTGRES_PASSWORD: secret
    ports:
      - '5432:5432'
    volumes:
      - pgdata-dev:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U threewc -d threewc']
      interval: 10s
      timeout: 3s
      retries: 10

  api-dev:
    image: node:24-alpine
    container_name: 3wc-api-dev
    working_dir: /app

    entrypoint: ['/bin/sh', '-lc']
    command: >
      'corepack enable &&
       pnpm install --frozen-lockfile --prefer-offline --reporter=silent --no-optional &&
       pnpm run migrate:dev &&
       pnpm exec tsx watch src/app.ts'

    env_file:
      - .env.dev
    environment:
      NODE_ENV: development
      PORT: 4000
      DOTENV_CONFIG_QUIET: 'true'
      PNPM_HOME: /root/.local/share/pnpm
      PNPM_STORE_DIR: /pnpm-store
      CI: 'true'

    ports:
      - '4000:4000'

    volumes:
      - .:/app
      - pnpm-store:/pnpm-store

    depends_on:
      postgres:
        condition: service_healthy

volumes:
  pgdata-dev:
  pnpm-store:
